name: build push and deploy image


on:
    push:
        branches: [main]
    pull_request:
            branches: [main]

permissions:
  id-token: write
  contents: read

env:
    AWS_REGION: us-east-1
    AWS_ROLE: ${{ secrets.MY_ACTION_ROLE }}
    ECR_REPO_NAME: dev
    IMAGE_TAG: ${{github.run_number}}


jobs:
    build:
        runs-on: ubuntu-latest #github runner
        steps:
            - name: clone repo
              uses: actions/checkout@v3
            - name: AWS creds config
              uses: aws-actions/configure-aws-credentials@v4
              with:
                role-to-assume: ${{ env.AWS_ROLE }}
                aws-region: ${{ env.AWS_REGION }}
            - name: login ton ecr
              uses: aws-actions/amazon-ecr-login@v1
              id: ecr-login
            - name: Build and tag image
              id: build-and-push
              run: |
                docker build -t ${{steps.ecr-login.outputs.registry}}/${{env.ECR_REPO_NAME}}:${{env.IMAGE_TAG}} .
            
            - name: scan docker image for vulnerability
              uses: aquaasecurity/trivy-action@mater
              with:
                image-ref: "${{steps.ecr-login.outputs.registry}}/${{env.ECR_REPO_NAME}}:${{env.IMAGE_TAG}}"
                format: "table"
                exit-code: "1"
                severity: "CRITICAL, HIGH"
                
            - name: push to ecr
              run: |
                docker push ${{steps.ecr-login.outputs.registry}}/${{env.ECR_REPO_NAME}}:${{env.IMAGE_TAG}}
